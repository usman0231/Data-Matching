<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Matcher - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">

<!-- Header -->
<header class="bg-gray-900 border-b border-gray-800 px-6 py-4">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-white">Data Matcher</h1>
            <p class="text-gray-400 text-sm">Multi-client payment reconciliation</p>
        </div>
        <div class="flex items-center gap-4">
            <a href="/settings" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm transition-colors">Settings</a>
            <select id="daysSelect" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm">
                <option value="1">Last 1 Day</option>
                <option value="2" selected>Last 2 Days</option>
                <option value="3">Last 3 Days</option>
                <option value="7">Last 7 Days</option>
                <option value="14">Last 14 Days</option>
                <option value="30">Last 30 Days</option>
            </select>
            <button id="runBtn" onclick="runMatching()"
                class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 disabled:cursor-not-allowed px-5 py-2 rounded-lg font-medium text-sm transition-colors flex items-center gap-2">
                <svg id="runSpinner" class="spinner w-4 h-4 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                </svg>
                <span id="runBtnText">Run Matching</span>
            </button>
        </div>
    </div>
</header>

<!-- Main Content -->
<main class="max-w-7xl mx-auto px-6 py-8">

    <!-- Status Banner -->
    <div id="messageBanner" class="border rounded-lg px-4 py-3 mb-6 items-center justify-between hidden">
        <span id="messageText"></span>
        <button onclick="document.getElementById('messageBanner').classList.add('hidden')" class="text-gray-400 hover:text-white">&times;</button>
    </div>

    <!-- No Data State -->
    <div id="noDataState" class="text-center py-20">
        <div class="text-gray-600 text-6xl mb-4">&#9881;</div>
        <h2 class="text-xl font-semibold text-gray-300 mb-2">No Data Yet</h2>
        <p class="text-gray-500 mb-6">Click "Run Matching" to start the reconciliation pipeline</p>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboardContent" class="hidden">

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-gray-900 rounded-xl border border-gray-800 p-5">
                <div class="text-gray-400 text-sm mb-1">Total Matched</div>
                <div id="totalMatched" class="text-3xl font-bold text-green-400">0</div>
            </div>
            <div class="bg-gray-900 rounded-xl border border-gray-800 p-5">
                <div class="text-gray-400 text-sm mb-1">Total Unmatched</div>
                <div id="totalUnmatched" class="text-3xl font-bold text-red-400">0</div>
            </div>
            <div class="bg-gray-900 rounded-xl border border-gray-800 p-5">
                <div class="text-gray-400 text-sm mb-1">Clients Processed</div>
                <div id="totalClients" class="text-3xl font-bold text-blue-400">0</div>
            </div>
            <div class="bg-gray-900 rounded-xl border border-gray-800 p-5">
                <div class="text-gray-400 text-sm mb-1">Time Elapsed</div>
                <div id="timeElapsed" class="text-3xl font-bold text-purple-400">0s</div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-gray-900 rounded-xl border border-gray-800 p-5">
                <h3 class="text-lg font-semibold mb-4">Match Rate by Client</h3>
                <div style="position:relative; height:250px;">
                    <canvas id="matchRateChart"></canvas>
                </div>
            </div>
            <div class="bg-gray-900 rounded-xl border border-gray-800 p-5">
                <h3 class="text-lg font-semibold mb-4">Overall Distribution</h3>
                <div style="position:relative; height:250px;">
                    <canvas id="overallChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="mb-6 flex items-center gap-4">
            <h3 class="text-lg font-semibold">Client Details</h3>
            <select id="clientFilter" onchange="renderClients()" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm">
                <option value="all">All Clients</option>
            </select>
            <select id="statusFilter" onchange="renderClients()" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm">
                <option value="all">All Status</option>
                <option value="unmatched">Unmatched Only</option>
                <option value="errors">Errors Only</option>
            </select>
            <input type="text" id="searchInput" oninput="renderClients()" placeholder="Search email, order, PI..."
                   class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm w-64">
        </div>

        <!-- Client Cards Container -->
        <div id="clientCards"></div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// ─── State ──────────────────────────────────────────────
let lastRun = null;
let isRunning = false;
let matchRateChart = null;
let overallChart = null;
let expandedClients = {};

// ─── Init ───────────────────────────────────────────────
(async function init() {
    try {
        const resp = await fetch('/api/status');
        const data = await resp.json();
        if (data.last_run) {
            lastRun = data.last_run;
            showDashboard();
        }
    } catch(e) {
        console.error('Init failed:', e);
    }
})();

// ─── Run Matching ───────────────────────────────────────
async function runMatching() {
    if (isRunning) return;
    isRunning = true;
    updateRunButton();
    hideMessage();

    const days = document.getElementById('daysSelect').value;

    try {
        const resp = await fetch(`/api/run-sync?days=${days}`, { method: 'POST' });
        const data = await resp.json();
        if (data.error) {
            showMessage(data.error, 'error');
        } else {
            lastRun = data;
            showMessage(
                `Completed in ${data.elapsed_seconds}s - ${data.totals.matched} matched, ${data.totals.unmatched} unmatched`,
                'success'
            );
            showDashboard();
        }
    } catch (e) {
        showMessage('Request failed: ' + e.message, 'error');
    } finally {
        isRunning = false;
        updateRunButton();
    }
}

// ─── Show Dashboard ─────────────────────────────────────
function showDashboard() {
    if (!lastRun) return;

    document.getElementById('noDataState').classList.add('hidden');
    document.getElementById('dashboardContent').classList.remove('hidden');

    // Summary cards
    document.getElementById('totalMatched').textContent = lastRun.totals.matched;
    document.getElementById('totalUnmatched').textContent = lastRun.totals.unmatched;
    document.getElementById('totalClients').textContent = lastRun.clients.length;
    document.getElementById('timeElapsed').textContent = lastRun.elapsed_seconds + 's';

    // Client filter dropdown
    const clientFilter = document.getElementById('clientFilter');
    clientFilter.innerHTML = '<option value="all">All Clients</option>';
    lastRun.clients.forEach(c => {
        clientFilter.innerHTML += `<option value="${c.name}">${c.name}</option>`;
    });

    // Render charts and client cards
    renderCharts();
    renderClients();
}

// ─── Charts ─────────────────────────────────────────────
function renderCharts() {
    if (!lastRun?.clients) return;

    const ctx1 = document.getElementById('matchRateChart');
    const ctx2 = document.getElementById('overallChart');

    if (!ctx1 || !ctx2) {
        console.error('Canvas elements not found');
        return;
    }

    if (matchRateChart) { matchRateChart.destroy(); matchRateChart = null; }
    if (overallChart) { overallChart.destroy(); overallChart = null; }

    const clients = lastRun.clients;

    matchRateChart = new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: clients.map(c => c.name),
            datasets: [
                {
                    label: 'Matched',
                    data: clients.map(c => c.matched),
                    backgroundColor: 'rgba(34, 197, 94, 0.7)',
                    borderRadius: 4,
                },
                {
                    label: 'Unmatched',
                    data: clients.map(c => c.unmatched),
                    backgroundColor: 'rgba(239, 68, 68, 0.7)',
                    borderRadius: 4,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#9ca3af' } } },
            scales: {
                x: { ticks: { color: '#9ca3af' }, grid: { color: '#1f2937' } },
                y: { ticks: { color: '#9ca3af' }, grid: { color: '#1f2937' } }
            }
        }
    });

    overallChart = new Chart(ctx2, {
        type: 'doughnut',
        data: {
            labels: ['Matched', 'Unmatched'],
            datasets: [{
                data: [lastRun.totals.matched, lastRun.totals.unmatched],
                backgroundColor: ['rgba(34, 197, 94, 0.8)', 'rgba(239, 68, 68, 0.8)'],
                borderWidth: 0,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#9ca3af' } } }
        }
    });
}

// ─── Client Cards ───────────────────────────────────────
function renderClients() {
    if (!lastRun?.clients) return;

    const clientFilter = document.getElementById('clientFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const search = document.getElementById('searchInput').value.toLowerCase();

    let clients = lastRun.clients.filter(c => {
        if (clientFilter !== 'all' && c.name !== clientFilter) return false;
        if (statusFilter === 'errors' && !c.error) return false;
        if (statusFilter === 'unmatched' && c.unmatched === 0) return false;
        return true;
    });

    const container = document.getElementById('clientCards');
    container.innerHTML = '';

    clients.forEach(client => {
        const isExpanded = expandedClients[client.name] || false;
        const statusDot = client.error ? 'bg-red-500' : 'bg-green-500';

        let records = client.unmatched_records || [];
        if (search) {
            records = records.filter(r =>
                String(r.donor_email || '').toLowerCase().includes(search) ||
                String(r.order_no || '').toLowerCase().includes(search) ||
                String(r.payment_intent || '').toLowerCase().includes(search) ||
                String(r.invoiceid || '').toLowerCase().includes(search) ||
                String(r.donor_name || '').toLowerCase().includes(search)
            );
        }

        let tableHTML = '';
        if (client.error) {
            tableHTML = `<div class="px-5 py-3 bg-red-900/30 text-red-300 text-sm">Error: ${client.error}</div>`;
        } else if (records.length > 0) {
            tableHTML = `<div class="overflow-x-auto"><table class="w-full text-sm">
                <thead class="bg-gray-800/50"><tr>
                    <th class="px-4 py-2 text-left text-gray-400">ID</th>
                    <th class="px-4 py-2 text-left text-gray-400">Invoice</th>
                    <th class="px-4 py-2 text-left text-gray-400">Order No</th>
                    <th class="px-4 py-2 text-left text-gray-400">Payment Intent</th>
                    <th class="px-4 py-2 text-left text-gray-400">Status</th>
                    <th class="px-4 py-2 text-left text-gray-400">Amount</th>
                    <th class="px-4 py-2 text-left text-gray-400">Donor</th>
                    <th class="px-4 py-2 text-left text-gray-400">Email</th>
                    <th class="px-4 py-2 text-left text-gray-400">Created</th>
                </tr></thead><tbody>` +
                records.map(r => {
                    const statusClass = r.payment_status === 'succeeded'
                        ? 'bg-green-900 text-green-300' : 'bg-yellow-900 text-yellow-300';
                    return `<tr class="border-t border-gray-800/50 hover:bg-gray-800/30">
                        <td class="px-4 py-2">${r.id || ''}</td>
                        <td class="px-4 py-2">${r.invoiceid || ''}</td>
                        <td class="px-4 py-2">${r.order_no || ''}</td>
                        <td class="px-4 py-2 font-mono text-xs">${r.payment_intent || ''}</td>
                        <td class="px-4 py-2"><span class="px-2 py-0.5 rounded text-xs ${statusClass}">${r.payment_status || ''}</span></td>
                        <td class="px-4 py-2">${r.amount || ''} ${r.currency || 'USD'}</td>
                        <td class="px-4 py-2">${r.donor_name || ''}</td>
                        <td class="px-4 py-2">${r.donor_email || ''}</td>
                        <td class="px-4 py-2 text-gray-400">${r.created_at || ''}</td>
                    </tr>`;
                }).join('') +
                `</tbody></table></div>`;
        } else {
            tableHTML = `<div class="px-5 py-8 text-center text-gray-500">All records matched successfully</div>`;
        }

        container.innerHTML += `
            <div class="bg-gray-900 rounded-xl border border-gray-800 mb-4 overflow-hidden">
                <div onclick="toggleClient('${client.name}')"
                     class="px-5 py-4 flex items-center justify-between cursor-pointer hover:bg-gray-800/50 transition-colors">
                    <div class="flex items-center gap-4">
                        <div class="w-3 h-3 rounded-full ${statusDot}"></div>
                        <div>
                            <span class="font-semibold">${client.name}</span>
                            <span class="text-gray-500 text-sm ml-2">Match Rate: ${client.match_rate}%</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-6 text-sm">
                        <span class="text-green-400">Matched: ${client.matched}</span>
                        <span class="text-red-400">Unmatched: ${client.unmatched}</span>
                        <span class="text-gray-400">Checkouts: ${client.total_checkouts}</span>
                        <span class="text-gray-400">Txns: ${client.total_transactions}</span>
                        <svg class="w-5 h-5 text-gray-500 transition-transform ${isExpanded ? 'rotate-180' : ''}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
                <div class="border-t border-gray-800 ${isExpanded ? '' : 'hidden'}" id="client-${client.name.replace(/\s/g,'_')}">
                    ${tableHTML}
                </div>
            </div>`;
    });
}

function toggleClient(name) {
    expandedClients[name] = !expandedClients[name];
    renderClients();
}

// ─── UI Helpers ─────────────────────────────────────────
function updateRunButton() {
    const btn = document.getElementById('runBtn');
    const spinner = document.getElementById('runSpinner');
    const text = document.getElementById('runBtnText');
    btn.disabled = isRunning;
    spinner.classList.toggle('hidden', !isRunning);
    text.textContent = isRunning ? 'Running...' : 'Run Matching';
}

function showMessage(msg, type) {
    const banner = document.getElementById('messageBanner');
    const text = document.getElementById('messageText');
    banner.className = `border rounded-lg px-4 py-3 mb-6 flex items-center justify-between ${
        type === 'error' ? 'bg-red-900/50 border-red-700' : 'bg-green-900/50 border-green-700'
    }`;
    text.textContent = msg;
}

function hideMessage() {
    document.getElementById('messageBanner').classList.add('hidden');
}
</script>
</body>
</html>
